---
import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';
import Base from '../../layouts/Base.astro';
import { remark } from 'remark';
import rehypeRaw from 'rehype-raw';
import rehypeStringify from 'rehype-stringify';
import remarkParse from 'remark-parse';
import remarkRehype from 'remark-rehype';
import rehypeImage from '../../plugins/rehype-image.js';

export async function getStaticPaths() {
  const postsDirectory = './posts';
  const postFiles = fs.readdirSync(postsDirectory).filter(f => f.endsWith('.md'));
  return postFiles.map(filename => ({ params: { slug: filename.replace(/\.md$/, '') } }));
}

const { slug } = Astro.params;
const filePath = `./posts/${slug}.md`;
const fileContent = fs.readFileSync(filePath, 'utf-8');
const { data, content } = matter(fileContent);

const file = await remark()
  .use(remarkParse)
  .use(remarkRehype, { allowDangerousHtml: true })
  .use(rehypeRaw)
  .use(rehypeImage)
  .use(rehypeStringify)
  .process(content);

const html = String(file);
---

<Base>
  <span slot="title">{data.title}</span>

  <main class="w-full px-4 sm:px-6 md:px-8 pt-20 pb-24 flex justify-center box-border">
    <article class="max-w-2xl w-full box-border">

      <!-- ðŸ”™ FLECHE RETOUR -->
      <a href="/" class="inline-flex items-center text-sm text-[#b3a89c] hover:text-[#3a3732] transition-all group mb-6">
        <svg class="w-4 h-4 mr-2 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        Back to home
      </a>

      <!-- ðŸŸ¢ TITRE -->
      <h1 class="text-3xl font-serif font-semibold text-[#3a3732] mb-2">{data.title}</h1>

      <!-- ðŸŸ¤ DESCRIPTION -->
      {data.description && (
        <p class="text-lg text-[#9c8e82] mb-2 leading-snug">{data.description}</p>
      )}

      <!-- ðŸ“… DATE -->
      <div class="text-sm text-[#c7beb7] mb-10">{data.date}</div>

      <!-- ðŸ“„ CONTENU MARKDOWN (maintenant dans <article>) -->
      <div class="relative">
        <style>
          .fullwidth {
            width: 100vw;
            max-width: 100vw;
            margin-left: calc(-1 * (100vw - 100%) / 2);
            margin-right: calc(-1 * (100vw - 100%) / 2);
            display: block;
          }

          @media (min-width: 640px) {
            .fullwidth {
              max-width: 500px;
              margin-left: auto;
              margin-right: auto;
              border-radius: 0.75rem;
            }
          }
        </style>

        <div
          class="prose prose-lg text-[#6a5f55] leading-relaxed
            max-w-none
            prose-blockquote:border-l-4 prose-blockquote:border-[#b3a89c] prose-blockquote:pl-4 prose-blockquote:italic 
            prose-a:underline prose-a:decoration-[#b3a89c] prose-a:underline-offset-2 prose-a:font-medium 
            prose-strong:font-semibold prose-strong:text-[#7a6f66] prose-hr:my-8 
            prose-p:text-[#6a5f55]"
          set:html={html}
        />
      </div>

    </article>
  </main>
</Base>
